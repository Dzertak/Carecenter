unit UnitStudents;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, jpeg, ExtCtrls, DBGridEhGrouping, ToolCtrlsEh,
  DBGridEhToolCtrls, GridsEh, DBGridEh, StdCtrls, DBCtrls, Buttons,superobject,
  frxpngimage, Mask;

type
  TFormStudents = class(TForm)
    img1: TImage;
    img2: TImage;
    dbgrdh1: TDBGridEh;
    edt1: TEdit;
    img3: TImage;
    img4: TImage;
    img5: TImage;
    lbl1: TLabel;
    btn1: TButton;
    btn2: TButton;
    dbedt1: TDBEdit;
    procedure edt1Change(Sender: TObject);
    procedure btn1Click(Sender: TObject);
    procedure img4Click(Sender: TObject);
    procedure img5Click(Sender: TObject);
    procedure btn2Click(Sender: TObject);
    procedure btn3Click(Sender: TObject);
    procedure img3Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormStudents: TFormStudents;
  isSorted:Boolean;
      JsonObject: ISuperObject;
    JsonStream: TStringStream;

implementation

uses
  UnitDataModule, UnitJSON, DB, UnitAddStudent, UnitPrint, UnitSpecial;

{$R *.dfm}

procedure TFormStudents.edt1Change(Sender: TObject);
begin
 with DataModule1.qryStudents do
begin
Active:=False;
sql.Clear;
SQL.Add('Select с.Код_студента, с.Код_специальности, с.ФИО, спец.Название As Специальность, с.Группа, с.Год_поступления, с.Год_выпуска, с.Примечание');
SQL.Add(' From Студенты с, Специальности спец');
SQL.Add(' Where с.Код_специальности=спец.Код_специальности');
SQL.Add(' AND (с.ФИО LIKE ''%'+edt1.Text+'%'' OR спец.Название LIKE ''%'+edt1.Text+'%'' OR с.Группа LIKE ''%'+edt1.Text+'%''' );
SQL.Add('OR с.Примечание LIKE ''%'+edt1.Text+'%'' OR с.Год_поступления LIKE ''%'+edt1.Text+'%'' OR с.Год_выпуска LIKE ''%'+edt1.Text+'%'')');
Open;
end;
end;

procedure TFormStudents.btn1Click(Sender: TObject);
var count,i:Integer;
begin
FormJSON.mmo1.Lines.Clear;
FormJSON.mmo1.Lines.Add('{');
FormJSON.mmo1.Lines.Add(' "Студенты":[');
DataModule1.qryStudents.Last;
count:=DataModule1.qryStudents.RecordCount;
DataModule1.qryStudents.First;
i:=1;
with DataModule1.qryStudents do
begin
while not Eof do
begin
FormJSON.mmo1.Lines.Add('{');
FormJSON.mmo1.Lines.Add('"Код_студента":'+FieldByName('Код_Студента').AsString+',');
FormJSON.mmo1.Lines.Add('"ФИО":"'+FieldByName('ФИО').AsString+'",');
FormJSON.mmo1.Lines.Add('"Код_Специальности":'+FieldByName('Код_специальности').AsString+',');
FormJSON.mmo1.Lines.Add('"Группа":"'+FieldByName('Группа').AsString+'",');
FormJSON.mmo1.Lines.Add('"Год_поступления":"'+FieldByName('Год_поступления').AsString+'",');
FormJSON.mmo1.Lines.Add('"Год_выпуска":"'+FieldByName('Год_выпуска').AsString+'",');
FormJSON.mmo1.Lines.Add('"Примечание":"'+FieldByName('Примечание').AsString+'"');
if i=count then
FormJSON.mmo1.Lines.Add('}')
else  FormJSON.mmo1.Lines.Add('},');
i:=i+1;
Next;
end;
First;
end;
FormJSON.mmo1.Lines.Add(']');
FormJSON.mmo1.Lines.Add('}');
FormJSON.Show;
end;

procedure TFormStudents.img4Click(Sender: TObject);
begin
FormAddStudent.Show;
end;

procedure TFormStudents.img5Click(Sender: TObject);
begin
//FormPrint.Show;
FormPrint.frxrprt1.ShowReport();
FormPrint.frxrprt1.Export(FormPrint.frxpdfxprt1);
end;

procedure TFormStudents.btn2Click(Sender: TObject);
begin
FormSpecial.Show;
end;

procedure TFormStudents.btn3Click(Sender: TObject);
begin
ShowMessage(dbedt1.Text);
end;

procedure TFormStudents.img3Click(Sender: TObject);
var command:AnsiString;
note:string;
begin
with DataModule1.qrySQL do
begin
  Active:=False;
  SQL.Clear;
  SQL.Text:='Select * From Студенты Where Код_студента='+dbedt1.Text;
  Open;
end;
  if MessageDlg('Вы действительно хотите перевести студента '+#10+#13+DataModule1.qrySQL.FieldByName('ФИО').AsString+' в архив?',mtConfirmation,[mbYes,mbNo],0)=mrYes then
  begin
note:=InputBox('Причина удаления','Введите "Примечание для студента"','');
command:='Insert into Архив_студентов(ФИО,Код_специальности,Группа,Год_поступления,Год_выпуска,Примечание) '+
'Select ФИО,Код_специальности,Группа,Год_поступления,Год_выпуска,Примечание+". '+note+'" From Студенты '+
'Where Код_студента='+dbedt1.Text;
DataModule1.cmd1.CommandText:=command;
DataModule1.cmd1.Execute;
DataModule1.cmd1.CommandText:='Delete From Студенты Where Код_студента='+dbedt1.Text;
DataModule1.cmd1.Execute;
ShowMessage('Студент переведён в архив');
end;
 end;
end.
